---
title: "Model Summary"
output: "html_document"
---

```{r, include=FALSE, message=FALSE}
library(tidyverse)

source("workflow/scripts/rmarkdown/common/plots.r")

mod <- snakemake@input[["model"]] %>%
    jsonlite::read_json(simplifyVector = TRUE, simplifyDataFrame = FALSE)
ypred <- read.csv(snakemake@input[["predictions"]])

to_tibble <- function(lst) {
    do.call(tibble, lst)
}

global_df <- to_tibble(mod$global)

univariate <- mod$univariate %>%
    map(~ list(meta = .x[c("name", "vartype")], df = to_tibble(.x[["df"]])))

```

# Model Statistics

## Overview

* N: `r nrow(ypred)`
* Perc. Pos: `r sum(ypred$label)/nrow(ypred)`

## Prediction Distribution

```{r, echo = FALSE, results = "asis", fig.width = 7, fig.height = 4}
ggplot(ypred, aes(prob, color = factor(label))) +
    geom_density() +
    xlab("probability") +
    scale_color_discrete(name = "label")
```

## ROC Curve

```{r, include=FALSE}

AllP <- sum(ypred$label)
AllN <- nrow(ypred) - AllP

roc <- ypred %>%
    arrange(prob) %>%
    mutate(thresh_FN = cumsum(label),
           thresh_TN = row_number() - thresh_FN,
           thresh_TP = AllP - thresh_FN,
           thresh_FP = AllN - thresh_TN,
           TPR = thresh_TP / AllP,
           TNR = thresh_TN / AllN,
           FPR = 1 - TNR,
           precision = thresh_TP / (thresh_TP + thresh_FP))

```

```{r, echo = FALSE, results = "asis", fig.width = 4, fig.height = 4}
roc %>%
    arrange(FPR, TPR) %>%
    ggplot(aes(FPR, TPR)) +
    geom_line()

roc %>%
    filter(!is.na(precision)) %>%
    arrange(TPR, desc(precision)) %>%
    ggplot(aes(TPR, precision)) +
    geom_line()
```

# Global Score Plot


```{r, echo = FALSE}
ggplot(global_df, aes(score, reorder(variable, score))) +
    geom_col() +
    xlab("Score") +
    ylab(NULL)

```

# Univariate plots

```{r, echo = FALSE, results = "asis", fig.width = 8, fig.height = 4}

make_continuous_plot <- function(df, name) {
    infer_transform(df$value) %>%
        mutate(score = df$score) %>%
        gather(-score, key = trans, value = x) %>%
        ggplot(aes(x, score)) +
        geom_step() +
        xlab(name) +
        ylab("Score") +
        facet_wrap(~trans, scales = "free")
}

make_categorical_plot <- function(df, name) {
    ggplot(df, aes(factor(value), score)) +
        geom_col() +
        xlab(name) +
        ylab("Score")
}

print_uv_plot <- function(vartype, df, name) {
    if (vartype == "continuous") {
        p <- make_continuous_plot(df, name)
    } else if (vartype == "categorical") {
        p <- make_categorical_plot(df, name)
    } else {
        p <- sprintf("wrong plot type, dummy; got %s", vartype)
    }

    cat(sprintf("## %s\n", name))
    print(p)
    cat("\n\n")
}

walk(univariate, ~ print_uv_plot(.x$meta$vartype, .x$df, .x$meta$name))

```

# Bivariate plots

not implenented

```{r, echo = FALSE, results = "asis", fig.width = 6, fig.height = 3.5}

cont_cont_plot <- function(df, left_name, right_name) {
    # poor-mans 2d step heatmap plot thing
    df %>%
        group_by(right) %>%
        mutate(left_upper = lead(left)) %>%
        ungroup() %>%
        group_by(left) %>%
        mutate(right_upper = lead(right)) %>%
        ungroup() %>%
        filter(!is.na(left_upper)) %>%
        filter(!is.na(right_upper)) %>%
        ggplot() +
        geom_rect(aes(xmin = left,
                      xmax = left_upper,
                      ymin = right,
                      ymax = right_upper,
                      fill = score)) +
        xlab(left_name) +
        ylab(right_name) +
        scale_fill_gradient2(low = "red",
                             mid = "black",
                             high = "green",
                             midpoint = 0)
}

cont_cat_plot <- function(df, cat, cont, cat_name, cont_name) {
    ggplot(df, aes_string(cont, "score", color = factor(cat))) +
        geom_step() +
        xlab(cont_name) +
        scale_fill_discrete(name = cat_name)
}

cat_cat_plot <- function(df, left_name, right_name) {
    ggplot(df, aes(left, score, fill = factor(right))) +
        geom_col(position = "dodge") +
        xlab(left_name) +
        scale_fill_discrete(name = right_name)
}

print_bv_plot <- function(L, R, df) {
    if (L$type == "continuous" && R$type == "continuous") {
        p <- cont_cont_plot(df, L$name, R$name)
    } else if (L$type == "categorical" && R$type == "continuous") {
        p <- cont_cat_plot(df, "left", "right", L$name, R$name)
    } else if (L$type == "continuous" && R$type == "categorical") {
        p <- cont_cat_plot(df, "right", "left", R$name, L$name)
    } else if (L$type == "categorical" && R$type == "categorical") {
        p <- cat_cat_plot(df, R$name, L$name)
    } else {
        p <- sprintf("Types are wrong, dummy: %s and/or %s", L$type, R$type)
    }
    cat(sprintf("## %s x %s\n\n", L$name, R$name))
    print(p)
    cat("\n\n")
}

## dfs <- py$bivariate_dfs

## if (length(dfs) == 0) {
##     cat("None\n\n")
## } else {
##     walk(dfs, ~ print_bv_plot(.x[["left"]], .x[["right"]], .x[["df"]]))
## }

```
