---
title: "Model Summary"
output: "html_document"
---

```{r, include=FALSE, message=FALSE}
library(tidyverse)

source("workflow/scripts/rmarkdown/common/plots.r")


to_tibble <- function(lst) {
    do.call(tibble, lst)
}

get_run_features <- function(wildcards, config) {
    run_key <- wildcards[["run_key"]]
    config[["ebm_runs"]][[run_key]][["features"]]
}

read_model <- function(path) {
    jsonlite::read_json(path, simplifyVector = TRUE, simplifyDataFrame = FALSE)
}

read_predictions <- function(path) {
    readr::read_csv(path, col_types = cols(.default = "d"))
}

read_input_paths <- function(path) {
    jsonlite::read_json(path) %>%
        set_names(~ basename(dirname(.x)))
}

lookup_input_path <- function(mapping, k) {
    pluck(mapping, as.character(as.integer(k)))
}

to_univariate <- function(model) {
    model$univariate %>%
        map(~ list(meta = .x[c("name", "vartype")], df = to_tibble(.x[["df"]])))
}

to_bivariate <- function(model) {
    model$bivariate %>%
        map(~ list(left = .x$left, right = .x$right, df = to_tibble(.x$df)))
}

run_features <- get_run_features(snakemake@wildcards, snakemake@config)

mod <- read_model(snakemake@input[["model"]])
ypred <- read_predictions(snakemake@input[["predictions"]])
input_keys <- read_input_paths(snakemake@input[["paths"]])

VCF_input_name <- "VCF_input"

global_df <- to_tibble(mod$global)

univariate <- to_univariate(mod)
bivariate <- to_bivariate(mod)

```

# Model Statistics

## Input file keys:

```{r, echo = F, results = "asis"}

iwalk(input_keys, ~ cat(sprintf("- %d: %s\n", .x, .y)))
cat("\n")

```

## Overview

* N: `r nrow(ypred)`
* Perc. Pos: `r sum(ypred$label)/nrow(ypred)`

## Prediction Distribution

```{r, echo = FALSE, results = "asis", fig.width = 7, fig.height = 4}
ggplot(ypred, aes(prob, color = factor(label))) +
    geom_density() +
    xlab("probability") +
    scale_color_discrete(name = "label")
```

## ROC Curve

```{r, include=FALSE}

AllP <- sum(ypred$label)
AllN <- nrow(ypred) - AllP

roc <- ypred %>%
    arrange(prob) %>%
    mutate(thresh_FN = cumsum(label),
           thresh_TN = row_number() - thresh_FN,
           thresh_TP = AllP - thresh_FN,
           thresh_FP = AllN - thresh_TN,
           TPR = thresh_TP / AllP,
           TNR = thresh_TN / AllN,
           FPR = 1 - TNR,
           precision = thresh_TP / (thresh_TP + thresh_FP))

```

```{r, echo = FALSE, results = "asis", fig.width = 4, fig.height = 4}
roc %>%
    arrange(FPR, TPR) %>%
    ggplot(aes(FPR, TPR)) +
    geom_line()

roc %>%
    filter(!is.na(precision)) %>%
    arrange(TPR, desc(precision)) %>%
    ggplot(aes(TPR, precision)) +
    geom_line()
```

# Global Score Plot


```{r, echo = FALSE}
ggplot(global_df, aes(score, reorder(variable, score))) +
    geom_col() +
    xlab("Score") +
    ylab(NULL)

```

# Univariate plots

```{r, echo = FALSE, results = "asis", fig.width = 8, fig.height = 4, message = F}

get_truncation <- function(s) {
    run_features[[s]][["visualization"]][["truncate"]]
}

get_plot_type <- function(s) {
    run_features[[s]][["visualization"]][["plot_type"]]
}

truncate_maybe <- function(df, name) {
    t <- get_truncation(name)
    lower <- t[["lower"]]
    upper <- t[["upper"]]
    caption <- if (!is.null(lower) && !is.null(upper)) {
                   sprintf("Truncated from %d to %d", lower, upper)
               } else if (!is.null(lower)) {
                   sprintf("Truncated from %d to -Inf", lower)
               } else if (!is.null(upper)) {
                   sprintf("Truncated from -Inf to %d", upper)
               }
    .df <- if (is.null(lower) && is.null(upper)) {
               df
           } else {
               .lower <- if (is.null(lower)) min(df$value) else lower
               .upper <- if (is.null(upper)) max(df$value) else upper
               filter(df, .lower <= value & value <= .upper)
           }
    list(df = .df, lower = lower, upper = upper, caption = caption)
}

make_integer_plot <- function(df, xlab, lower = NULL, upper = NULL, caption = NULL) {
    fill_cols <- c("score", "stdev")
    .lower <- if (is.null(lower)) min(df$value) else lower
    .upper <- if (is.null(upper)) max(df$value) else upper
    .join <- tibble(value = .lower:.upper)
    .df <- mutate(df, value = ceiling(value)) %>%
        right_join(.join, by = "value") %>%
        arrange(value) %>%
        fill(all_of(fill_cols), .direction = "downup")
    p <- ggplot(.df, aes(value, score)) +
        geom_col() +
        xlab(xlab) +
        ylab("Score") +
        geom_errorbar(aes(ymin = score - stdev, ymax = score + stdev))
    if (is.null(caption)) p else p + labs(caption = caption)
}

make_continuous_plot <- function(df, name, caption) {
    p <- infer_transform(df$value) %>%
        mutate(score = df$score,
               lower = score - df$stdev,
               upper = score + df$stdev) %>%
        gather(-score, -upper, -lower, key = trans, value = x) %>%
        ggplot(aes(x, score)) +
        geom_step(aes(y = lower), color = "red") +
        geom_step(aes(y = upper), color = "red") +
        geom_step() +
        xlab(name) +
        ylab("Score") +
        facet_wrap(~trans, scales = "free")
    if (is.null(caption)) p else p + labs(caption = caption)
}

make_categorical_plot <- function(df, name) {
    ggplot(df, aes(factor(value), score)) +
        geom_col() +
        geom_errorbar(aes(ymin = score - stdev, ymax = score + stdev), width = 0.1) +
        xlab(name) +
        ylab("Score")
}

print_uv_plot <- function(vartype, df, name) {
    p <- if (vartype == "continuous") {
             tr <- truncate_maybe(df, name)
             t <- get_plot_type(name)
             if (t == "step") {
                 make_continuous_plot(tr[["df"]], name, tr[["caption"]])
             } else if (t == "bar") {
                 make_integer_plot(tr[["df"]],
                                   name,
                                   tr[["lower"]],
                                   tr[["upper"]],
                                   tr[["caption"]])
             } else {
                 sprintf("wrong type, dummy; got %s", t)
             }
         } else if (vartype == "categorical") {
             make_categorical_plot(df, name)
         } else {
             sprintf("wrong plot type, dummy; got %s", vartype)
         }

    cat(sprintf("## %s\n", name))
    print(p)
    cat("\n\n")
}

walk(univariate, ~ print_uv_plot(.x$meta$vartype, .x$df, .x$meta$name))

```

# Bivariate plots

```{r, echo = FALSE, results = "asis", fig.width = 6, fig.height = 3.5}

cont_cont_plot <- function(df, yvar, left_name, right_name) {
    # poor-mans 2d step heatmap plot thing
    df %>%
        group_by(right_value) %>%
        mutate(left_upper = lead(left_value)) %>%
        ungroup() %>%
        group_by(left_value) %>%
        mutate(right_upper = lead(right_value)) %>%
        ungroup() %>%
        filter(!is.na(left_upper)) %>%
        filter(!is.na(right_upper)) %>%
        ggplot() +
        geom_rect(aes_string(xmin = "left_value",
                             xmax = "left_upper",
                             ymin = "right_value",
                             ymax = "right_upper",
                             fill = yvar)) +
        xlab(left_name) +
        ylab(right_name) +
        scale_fill_gradient2(low = "red",
                             mid = "black",
                             high = "green",
                             midpoint = 0)
}

print_cont_cont_plot <- function(df, left_name, right_name) {
    cat("### Scores\n\n")
    print(cont_cont_plot(df, "score", left_name, right_name))
    cat("\n\n")
    cat("### Stdevs\n\n")
    print(cont_cont_plot(df, "stdev", left_name, right_name))
}

print_cont_cat_plot_inner <- function(df, cat_name, cont_name) {
    cat_val <- as.character(df$c[[1]])
    tr <- truncate_maybe(df, cont_name)
    t <- get_plot_type(cont_name)
    p <- if (t == "step") {
             .p <- ggplot(tr[["df"]], aes(value, score)) +
                 geom_step(aes(y = lower), color = "red") +
                 geom_step(aes(y = upper), color = "red") +
                 geom_step() +
                 xlab(cont_name)
             if (!is.null(tr[["caption"]])) {
                 .p + labs(caption = tr[["caption"]])
             } else {
                 .p
             }
         } else if (t == "bar") {
             make_integer_plot(tr[["df"]],
                               cont_name,
                               tr[["lower"]],
                               tr[["upper"]],
                               tr[["caption"]])
         } else {
             sprintf("wrong plot type: got %s", t)
         }
    
    cat(sprintf("### %s = %s\n\n", cat_name, cat_val))
    print(p)
    cat("\n\n")
}

print_cont_cat_plot <- function(df, cat, cont, cat_name, cont_name) {
    ## this 'all_of' thing is needed to silence a weird warning about
    ## using vectors to select things (I disagree with it, but whatever)
    .df <- rename(df, value = all_of(cont), c = all_of(cat)) %>%
        mutate(lower = score - stdev,
               upper = score + stdev) %>%
        group_split(c) %>%
        walk(~ print_cont_cat_plot_inner(.x, cat_name, cont_name))
}

print_cat_cat_plot <- function(df, left_name, right_name) {
    p <- ggplot(df, aes(factor(left_value),
                         score,
                         fill = factor(right_value)
                         )) +
        geom_col(position = "dodge") +
        geom_errorbar(aes(ymin = score - stdev,
                          ymax = score + stdev),
                      width = 0.1,
                      position = position_dodge(0.9)) +
        xlab(left_name) +
        scale_fill_discrete(name = right_name)
    print(p)
}

print_bv_plot_inner <- function(L, R, df) {
    if (L$type == "continuous" && R$type == "continuous") {
        print_cont_cont_plot(df, L$name, R$name)
    } else if (L$type == "categorical" && R$type == "continuous") {
        print_cont_cat_plot(df, "left_value", "right_value", L$name, R$name)
    } else if (L$type == "continuous" && R$type == "categorical") {
        print_cont_cat_plot(df, "right_value", "left_value", R$name, L$name)
    } else if (L$type == "categorical" && R$type == "categorical") {
        print_cat_cat_plot(df, L$name, R$name)
    } else {
        sprintf("Types are wrong, dummy: %s and/or %s", L$type, R$type)
    }
}

print_bv_plot <- function(L, R, df) {
    cat(sprintf("## %s x %s\n\n", L$name, R$name))

    print_bv_plot_inner(L, R, df)

    cat("\n\n")
}

if (length(bivariate) == 0) {
    cat("None\n\n")
} else {
    walk(bivariate, ~ print_bv_plot(.x$left, .x$right, .x$df))
}

```
