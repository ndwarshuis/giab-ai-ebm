---
title: "Model Summary"
output: "html_document"
---

```{r, include=FALSE, message=FALSE}
library(tidyverse)

source("workflow/scripts/rmarkdown/common/plots.r")

run_key <- snakemake@wildcards[["run_key"]]
run_config <- snakemake@config[["ebm_runs"]][[run_key]]
run_features <- run_config[["features"]]

mod <- snakemake@input[["model"]] %>%
    jsonlite::read_json(simplifyVector = TRUE, simplifyDataFrame = FALSE)
ypred <- readr::read_csv(snakemake@input[["predictions"]],
                         col_types = cols(.default = "d"))

to_tibble <- function(lst) {
    do.call(tibble, lst)
}

global_df <- to_tibble(mod$global)

univariate <- mod$univariate %>%
    map(~ list(meta = .x[c("name", "vartype")], df = to_tibble(.x[["df"]])))

bivariate <- mod$bivariate %>%
    map(~ list(left = .x$left,
               right = .x$right,
               df = to_tibble(.x$df)))

```

# Model Statistics

## Overview

* N: `r nrow(ypred)`
* Perc. Pos: `r sum(ypred$label)/nrow(ypred)`

## Prediction Distribution

```{r, echo = FALSE, results = "asis", fig.width = 7, fig.height = 4}
ggplot(ypred, aes(prob, color = factor(label))) +
    geom_density() +
    xlab("probability") +
    scale_color_discrete(name = "label")
```

## ROC Curve

```{r, include=FALSE}

AllP <- sum(ypred$label)
AllN <- nrow(ypred) - AllP

roc <- ypred %>%
    arrange(prob) %>%
    mutate(thresh_FN = cumsum(label),
           thresh_TN = row_number() - thresh_FN,
           thresh_TP = AllP - thresh_FN,
           thresh_FP = AllN - thresh_TN,
           TPR = thresh_TP / AllP,
           TNR = thresh_TN / AllN,
           FPR = 1 - TNR,
           precision = thresh_TP / (thresh_TP + thresh_FP))

```

```{r, echo = FALSE, results = "asis", fig.width = 4, fig.height = 4}
roc %>%
    arrange(FPR, TPR) %>%
    ggplot(aes(FPR, TPR)) +
    geom_line()

roc %>%
    filter(!is.na(precision)) %>%
    arrange(TPR, desc(precision)) %>%
    ggplot(aes(TPR, precision)) +
    geom_line()
```

# Global Score Plot


```{r, echo = FALSE}
ggplot(global_df, aes(score, reorder(variable, score))) +
    geom_col() +
    xlab("Score") +
    ylab(NULL)

```

# Univariate plots

```{r, echo = FALSE, results = "asis", fig.width = 8, fig.height = 4, message = F}

get_truncation <- function(s) {
    run_features[[s]][["truncate"]]
}

make_integer_plot <- function(df, xlab, lower, upper) {
    fill_cols <- c("score", "stdev")
    .df <- mutate(df, value = ceiling(value))
    .lower <- if (is.null(lower)) min(.df$value) else ceiling(lower)
    .upper <- if (is.null(upper)) max(.df$value) else ceiling(upper)
    .pdf <- .df %>%
        filter(.lower <= value & value <= .upper) %>%
        right_join(tibble(value = .lower:.upper), by = "value") %>%
        arrange(value) %>%
        fill(all_of(fill_cols), .direction = "downup")
    ggplot(.pdf, aes(value, score)) +
        geom_col() +
        xlab(xlab) +
        ylab("Score") +
        geom_errorbar(aes(ymin = score - stdev, ymax = score + stdev))
}

make_continuous_plot <- function(df, name) {
    infer_transform(df$value) %>%
        mutate(score = df$score,
               lower = score - df$stdev,
               upper = score + df$stdev) %>%
        gather(-score, -upper, -lower, key = trans, value = x) %>%
        ggplot(aes(x, score)) +
        geom_step(aes(y = lower), color = "red") +
        geom_step(aes(y = upper), color = "red") +
        geom_step() +
        xlab(name) +
        ylab("Score") +
        facet_wrap(~trans, scales = "free")
}

make_categorical_plot <- function(df, name) {
    ggplot(df, aes(factor(value), score)) +
        geom_col() +
        geom_errorbar(aes(ymin = score - stdev, ymax = score + stdev), width = 0.1) +
        xlab(name) +
        ylab("Score")
}

print_uv_plot <- function(vartype, df, name) {
    if (vartype == "continuous") {
        t <- get_truncation(name)
        if (is.null(t[["lower"]]) && is.null(t[["upper"]])) {
            p <- make_continuous_plot(df, name)
        } else {
            p <- make_integer_plot(df, name, t[["lower"]], t[["upper"]])
        }
    } else if (vartype == "categorical") {
        p <- make_categorical_plot(df, name)
    } else {
        p <- sprintf("wrong plot type, dummy; got %s", vartype)
    }

    cat(sprintf("## %s\n", name))
    print(p)
    cat("\n\n")
}

walk(univariate, ~ print_uv_plot(.x$meta$vartype, .x$df, .x$meta$name))

```

# Bivariate plots

```{r, echo = FALSE, results = "asis", fig.width = 6, fig.height = 3.5}

cont_cont_plot <- function(df, yvar, left_name, right_name) {
    # poor-mans 2d step heatmap plot thing
    df %>%
        group_by(right_value) %>%
        mutate(left_upper = lead(left_value)) %>%
        ungroup() %>%
        group_by(left_value) %>%
        mutate(right_upper = lead(right_value)) %>%
        ungroup() %>%
        filter(!is.na(left_upper)) %>%
        filter(!is.na(right_upper)) %>%
        ggplot() +
        geom_rect(aes_string(xmin = "left_value",
                             xmax = "left_upper",
                             ymin = "right_value",
                             ymax = "right_upper",
                             fill = yvar)) +
        xlab(left_name) +
        ylab(right_name) +
        scale_fill_gradient2(low = "red",
                             mid = "black",
                             high = "green",
                             midpoint = 0)
}

print_cont_cont_plot <- function(df, left_name, right_name) {
    cat("### Scores\n\n")
    print(cont_cont_plot(df, "score", left_name, right_name))
    cat("\n\n")
    cat("### Stdevs\n\n")
    print(cont_cont_plot(df, "stdev", left_name, right_name))
}

print_cont_cat_plot_inner <- function(df, cat_name, cont_name) {
    cat_val <- as.character(df$c[[1]])
    t <- get_truncation(cont_name)
    p <- if (is.null(t[["lower"]]) && is.null(t[["upper"]])) {
             ggplot(df, aes(value, score)) +
                 geom_step(aes(y = lower), color = "red") +
                 geom_step(aes(y = upper), color = "red") +
                 geom_step() +
                 xlab(cont_name)
         } else {
             make_integer_plot(df, cont_name, t[["lower"]], t[["upper"]])
         }
    cat(sprintf("### %s = %s\n\n", cat_name, cat_val))
    print(p)
    cat("\n\n")
}

print_cont_cat_plot <- function(df, cat, cont, cat_name, cont_name) {
    ## this 'all_of' thing is needed to silence a weird warning about
    ## using vectors to select things (I disagree with it, but whatever)
    .df <- rename(df, value = all_of(cont), c = all_of(cat)) %>%
        mutate(lower = score - stdev,
               upper = score + stdev) %>%
        group_split(c) %>%
        walk(~ print_cont_cat_plot_inner(.x, cat_name, cont_name))
}

print_cat_cat_plot <- function(df, left_name, right_name) {
    p <- mutate(df, right_value = factor(right_value)) %>%
        ggplot(aes(left_value, score, fill = right_value)) +
        geom_col(position = "dodge") +
        geom_errorbar(aes(ymin = score - stdev,
                          ymax = score + stdev),
                      width = 0.1,
                      position = position_dodge(0.9)) +
        xlab(left_name) +
        scale_fill_discrete(name = right_name)
    print(p)
}

print_bv_plot_inner <- function(L, R, df) {
    if (L$type == "continuous" && R$type == "continuous") {
        print_cont_cont_plot(df, L$name, R$name)
    } else if (L$type == "categorical" && R$type == "continuous") {
        print_cont_cat_plot(df, "left_value", "right_value", L$name, R$name)
    } else if (L$type == "continuous" && R$type == "categorical") {
        print_cont_cat_plot(df, "right_value", "left_value", R$name, L$name)
    } else if (L$type == "categorical" && R$type == "categorical") {
        print_cat_cat_plot(df, R$name, L$name)
    } else {
        sprintf("Types are wrong, dummy: %s and/or %s", L$type, R$type)
    }
}

print_bv_plot <- function(L, R, df) {
    cat(sprintf("## %s x %s\n\n", L$name, R$name))

    print_bv_plot_inner(L, R, df)

    cat("\n\n")
}

if (length(bivariate) == 0) {
    cat("None\n\n")
} else {
    walk(bivariate, ~ print_bv_plot(.x$left, .x$right, .x$df))
}

```
