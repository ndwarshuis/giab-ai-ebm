---
title: "Dataframe Summary"
output: "html_document"
---

```{r, echo=FALSE, message=FALSE}
library(tidyverse)

format_perc <- function(x) {
    sprintf("%.1f", x)
}

format_exp <- function(x) {
    sprintf("%.1e", x)
}

read_tsv <- function(path) {
    read.csv(path, sep = "\t", na.strings = c(".")) %>%
        as_tibble()
}

eval_nowarn <- function(f, xs) {
    .xs <- discard(xs, is.na)
    ifelse(length(.xs) == 0, NA, f(.xs))
}

make_stats_table <- function(df) {
    gather(df) %>%
        group_by(key) %>%
        summarize(min = eval_nowarn(min, value),
                  max = eval_nowarn(max, value),
                  med = median(value, na.rm = TRUE),
                  mean = mean(value, na.rm = TRUE),
                  stdev = mean(value, na.rm = TRUE),
                  range = max - min,
                  n_NA = sum(is.na(value)),
                  perc_NA = 100 * n_NA / n()) %>%
        rename(feature = key) %>%
        mutate(perc_NA = sprintf("%.1f", perc_NA)) %>%
        mutate(across(c(min, max, med, mean, stdev, range), format_exp))
}

make_feature_distribution <- function(x, labels) {
    ggplot() +
        aes(x, color = labels) +
        geom_density() +
        xlab(NULL) +
        ylab(NULL)
}

make_cor_plot <- function(df) {
    cor(df) %>%
        as_tibble(rownames = "var1") %>%
        gather(-var1, key = var2, value = coeff) %>%
        ggplot(aes(var1, var2, fill = coeff)) + geom_tile() +
        scale_fill_gradient2(low = "red",
                             mid = "black",
                             high = "green",
                             limits = c(-1, 1)) +
        xlab(NULL) +
        ylab(NULL) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1),
              legend.position = "bottom")
}

df <- read_tsv(snakemake@input[[1]])

df_x <- df %>%
    select(-label) %>%
    select(-CHROM, -POS, -POS.length.REF., -FILTER, -GT, -GQ)

df_y <- df$label

```

# Dataframe Overview

```{r, echo=FALSE}
N <- length(df_y)
P <- length(names(df_x))
N_TP <- length(keep(df_y, ~ .x == "tp"))
perc_TP <- sprintf("%.2f", 100 * N_TP / N)
```

* N Rows: `r N`
* N Features: `r P`
* N True Positives: `r N_TP`
* Perc True Postives: `r perc_TP`

# Feature Summary Tables

## Combined Labels

```{r, results = "asis", echo = FALSE}

df_x %>%
    make_stats_table() %>%
    knitr::kable()

```

## TP Label

```{r, results = "asis", echo = FALSE}

df_x %>%
    filter(df_y == "tp") %>%
    make_stats_table() %>%
    knitr::kable()

```

## FP Label

```{r, results = "asis", echo = FALSE}

df_x %>%
    filter(df_y == "fp") %>%
    make_stats_table() %>%
    knitr::kable()

```

# Colocalization Matrices

All missing values are converted to 0, and all present values are converted to
1, and the resulting correlation matrix is computed.

Interpretation:

- coeff = 1 means perfect colocalization (each value either missing or present)
- coeff = -1 means mutually exclusive


```{r, include = FALSE}

print_coloc <- function(df) {
    df_bin <- mutate(df, across(everything(), ~ if_else(is.na(.x), 0, 1)))

    singleval <- df_bin %>%
        gather() %>%
        group_by(key) %>%
        summarize(value = length(unique(value)) > 1) %>%
        filter(value == FALSE) %>%
        pull(key)

    cat("These features were removed as they had 1 unique value:\n\n")

    singleval %>%
        as.list() %>%
        walk(~ cat(sprintf("- %s\n", .x)))

    cat("\n")

    df_bin %>%
        select(-all_of(singleval)) %>%
        make_cor_plot() %>%
        print()

    cat("\n\n")
}

```

## Combined Labels

```{r, echo=FALSE, results = "asis", fig.width = 7, fig.height = 7}

print_coloc(df_x)

```

## TP Label

```{r, echo=FALSE, results = "asis", fig.width = 7, fig.height = 7}

filter(df_x, df_y == "tp") %>% print_coloc()

```

## FP Label

```{r, echo=FALSE, results = "asis", fig.width = 7, fig.height = 7}

filter(df_x, df_y == "fp") %>% print_coloc()

```

# Feature distributions

Plots of all features with missing values removed.

```{r, echo=FALSE, results="asis", fig.width=4, fig.height=4}

print_plot <- function(x, name) {
    cat(sprintf("## %s\n", name))

    .df <- tibble(x = x, y = df_y) %>%
        filter(!is.na(x))
    .x <- .df$x
    .y <- .df$y

    if (length(.x) == 0) {
        cat("Feature has no values")
    } else if (max(.x) - min(.x) == 0) {
        cat(sprintf("Feature has one value: %.1f", max(.x)))
    } else {
        print(make_feature_distribution(.x, .y))
    }

    cat("\n\n")
}

iwalk(df_x, ~ print_plot(.x, .y))

```
