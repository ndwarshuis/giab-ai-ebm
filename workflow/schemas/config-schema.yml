$schema: "http://json-schema.org/draft-07/schema#"
description: explainable boosted machines pipeline
required:
  - paths
  - inputs
  - resources
  - ebm_runs
additionalProperties: false
properties:

################################################################################
# paths

  paths:
    additionalProperties: false
    required:
      - resources
      - results
    properties:
      resources:
        description: the path in which snakemake will put resource files
        type: string
      results:
        description: the path in which snakemake will put result files
        type: string

################################################################################
# inputs

  inputs:
    additionalProperties: false
    patternProperties:
      ^[\w\.\-]+$:
        required:
          - vcf
          - ref
          - benchmark
        additionalProperties: false
        properties:
          benchmark:
            description: the benchmark index to use for this input
            type: string

          ref:
            description: the reference index to use for this input
            type: string

          vcf:
            description: the vcf to use for this input
            type: string

################################################################################
# resources

  resources:
    additionalProperties: false
    required:
      - benchmarks
      - references
      - annotations
    properties:

      benchmarks:
        additionalProperties: false
        patternProperties:
          ^[\w\.\-]+$:
            additionalProperties: false
            required:
              - vcf_url
              - bed_url
              - tbi_url
            properties:
              vcf_url:
                description: the url for the benchmark VCF to use
                type: string
                format: uri
              tbi_url:
                description: the url for the benchmark VCF TBI to use
                type: string
                format: uri
              bed_url:
                description: the url for the benchmark bed to use
                type: string
                format: uri

      references:
        additionalProperties: false
        patternProperties:
          ^[\w\.\-]+$:
            required:
              - sdf
            additionalProperties: false
            properties:
              sdf:
                description: the url for the reference SDF to use
                type: string
                format: uri

      annotations:
        additionalProperties: false
        required:
          - mappability
          - superdups
          - homopolymers
        properties:
          mappability:
            additionalProperties: false
            required:
            - low
            - high
            properties:
              low:
                description: the url for low stringency mappability bed file
                type: string
                format: uri
              high:
                description: the url for high stringency mappability bed file
                type: string
                format: uri

          superdups:
            description: the url to the superdups txt file
            type: string
            format: uri

          homopolymers:
            required:
              - find_regions
              - fasta
            additionalProperties: false
            properties:
              find_regions:
                description: |
                  the url of the script to use when finding simple repeat regions
                type: string
                format: uri
              fasta:
                description: |
                  the url of the fasta file containing the simple regions
                type: string
                format: uri

################################################################################
# EBM runs

  ebm_runs:
    additionalProperties: false
    patternProperties:
      ^[\w_]+_v[0-9]+$:
        additionalProperties: false
        required:
          - input
          - filter
          - features
          - ebm_settings
        properties:
          input:
            description: the input index to use for this run
            type: string

          filter:
            description: the filter to use for this run; either INDEL or SNP
            type: string
            pattern: ^INDEL|SNP$

          features:
            additionalProperties: false
            patternProperties:
              ^[\w_]+$:
                additionalProperties: false
                type: object
                default: {}
                properties:
                  feature_type:
                    type: string
                    default: continuous
                    pattern: ^continuous|categorical$
                  log_transform:
                    description: log transform the feature if 'true'
                    type: boolean
                    default: false
                  fill_na:
                    description: if present, fill missing values with this value
                    type: number
                    default: 0

          interactions:
            description: |
              either a list of explicit interactions to use or an integer
              representing the number of interactions to use automatically
            default: 0
            anyOf:
              - type: number
                minimum: 0
              - type: array
                items:
                  type: array
                  minItems: 2
                  items:
                    type: string
                    pattern: ^[\w\.\-]+$
                
          ebm_settings:
            additionalProperties: false
            properties:

              misc_parameters:
                description: |
                  random model parameters I don't know where else to put
                additionalProperties: false
                default: {}
                properties:
                  downsample:
                    default: null
                    anyOf:
                      - type: number
                        minimum: 0
                        maximum: 1
                      - type: "null"

              split_parameters:
                description: |
                  parameters for spliting the train/test data, will be sent to
                  'train_test_split' function
                additionalProperties: false
                default: {}
                properties:
                  test_size:
                    type: number
                    minimum: 0
                    maximum: 1
                    default: 0.2
    
                  random_state:
                    default: null
                    anyOf:
                      - type: number
                      - type: "null"

              # TODO where does mains belong?
              classifier_parameters:
                description: |
                  Parameters to train the EBM classifier, will be fed to
                  'ExplainableBoostingClassifier'. Note that 'feature_names',
                  'interactions', 'n_jobs', and 'mains' will be set elsewhere
                default: {}
                properties:
                  max_bins:
                    type: number
                    default: 256
    
                  max_interaction_bins:
                    type: number
                    default: 32
    
                  binning:
                    type: string
                    pattern: ^uniform|quantile|quantile_humanized$
                    default: quantile
    
                  outer_bags:
                    type: number
                    default: 8
    
                  inner_bags:
                    type: number
                    default: 0
    
                  learning_rate:
                    type: number
                    default: 0.01
    
                  validation_size:
                    type: number
                    default: 0.15
    
                  early_stopping_rounds:
                    type: number
                    default: 50
    
                  early_stopping_tolerance:
                    type: number
                    default: 0.0001
    
                  max_rounds:
                    type: number
                    default: 5000
    
                  min_samples_leaf:
                    type: number
                    default: 2
    
                  max_leaves:
                    type: number
                    default: 3
    
                  random_state:
                    type: number
                    default: null
                    anyOf:
                      - type: number
                      - type: "null"
